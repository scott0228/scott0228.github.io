---
layout: post
title: "如何在 Tomcat 中運用 JNDI 的方式取得 C3P0 的 connection pool"
date: 2008-10-26T17:46:00+08:00
categories:
 - java
---

<div class='post'>
<p>Tomcat 本來內建的 connection pool 是 dbcp，但據說有一堆 bug 沒解，因此想說要把 DBCP 換成 c3p0 以避免這些問題。剛好在網路上看到這個解法，就將它記下來嚕。</p>  <p>首先當然是要先把 c3p0 的 jar 檔及 jdbc driver 放到 tomcat 的 lib 目錄下。</p>  <h4>Tomcat 5.0</h4>  <p>在 Tomcat 的目錄下 conf/server.xml ，找到 &lt;Context&gt; 修改其內容： </p>  <p>&lt;Resource name=&quot;jdbc/pooledDS&quot; auth=&quot;Container&quot; type=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot; /&gt; &lt;ResourceParams name=&quot;jdbc/pooledDS&quot;&gt;   <br />&#160;&#160; &lt;parameter&gt;     <br />&#160;&#160;&#160;&#160;&#160; &lt;name&gt;factory&lt;/name&gt;    <br />&#160;&#160;&#160;&#160;&#160; &lt;value&gt;org.apache.naming.factory.BeanFactory&lt;/value&gt;     <br />&#160;&#160; &lt;/parameter&gt;    <br />&#160;&#160; &lt;parameter&gt;    <br />&#160;&#160;&#160;&#160;&#160; &lt;name&gt;driverClass&lt;/name&gt;     <br />&#160;&#160;&#160;&#160;&#160; &lt;value&gt;org.postgresql.Driver&lt;/value&gt;&#160; <br />&#160;&#160; &lt;/parameter&gt;    <br />&#160;&#160; &lt;parameter&gt;    <br />&#160;&#160;&#160;&#160;&#160; &lt;name&gt;jdbcUrl&lt;/name&gt;     <br />&#160;&#160;&#160;&#160;&#160; &lt;value&gt;jdbc:postgresql://localhost/c3p0-test&lt;/value&gt;&#160; <br />&#160;&#160; &lt;/parameter&gt;     <br />&#160;&#160; &lt;parameter&gt;     <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;name&gt;user&lt;/name&gt;    <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;value&gt;swaldman&lt;/value&gt;    <br />&#160;&#160;&#160; &lt;/parameter&gt;    <br />&#160;&#160;&#160; &lt;parameter&gt;    <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;name&gt;password&lt;/name&gt;     <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;value&gt;test&lt;/value&gt;    <br />&#160;&#160;&#160; &lt;/parameter&gt;     <br />&#160;&#160;&#160; &lt;parameter&gt;     <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;name&gt;minPoolSize&lt;/name&gt;     <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;value&gt;5&lt;/value&gt;    <br />&#160;&#160;&#160; &lt;/parameter&gt;     <br />&#160;&#160;&#160; &lt;parameter&gt;    <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;name&gt;maxPoolSize&lt;/name&gt;    <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;value&gt;15&lt;/value&gt;    <br />&#160;&#160;&#160; &lt;/parameter&gt;    <br />&#160;&#160;&#160; &lt;parameter&gt;    <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;name&gt;acquireIncrement&lt;/name&gt;    <br />&#160;&#160;&#160;&#160;&#160;&#160; &lt;value&gt;5&lt;/value&gt;    <br />&#160;&#160;&#160; &lt;/parameter&gt;     <br />&lt;/ResourceParams&gt;</p>  <h4>Tomcat 5.5/6.0</h4>  <p>在 Tomcat 的目錄下 conf/server.xml ，找到 &lt;GlobalNamingResources&gt; 加上其內容： </p>  <p>&lt;Resource auth=&quot;Container&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; description=&quot;DB Connection&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; driverClass=&quot;com.mysql.jdbc.Driver&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; maxPoolSize=&quot;4&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; minPoolSize=&quot;2&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; acquireIncrement=&quot;1&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; name=&quot;jdbc/TestDB&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; user=&quot;test&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; password=&quot;ready2go&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; factory=&quot;org.apache.naming.factory.BeanFactory&quot;     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; type=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; jdbcUrl=&quot;jdbc:mysql://localhost:3306/test?autoReconnect=true&quot; /&gt;</p>  <h4>Web.xml</h4>  <p>標準 J2EE 的程式中，需要在 web.xml 中做以下設定：</p>  <p>&lt;resource-ref&gt;    <br />&#160;&#160; &lt;res-ref-name&gt;jdbc/pooledDS&lt;/res-ref-name&gt;    <br />&#160;&#160; &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;    <br />&#160;&#160; &lt;res-auth&gt;Container&lt;/res-auth&gt;    <br /> &lt;/resource-ref&gt;</p>  <h4>如何利用程式取得 DataSource</h4>  <p>InitialContext ic = new InitialContext(); DataSource ds = (DataSource) ic.lookup(&quot;java:comp/env/jdbc/pooledDS&quot;);</p>  <p>原文參考：<a title="http://www.mchange.com/projects/c3p0/index.html#tomcat-specific" href="http://www.mchange.com/projects/c3p0/index.html#tomcat-specific">http://www.mchange.com/projects/c3p0/index.html#tomcat-specific</a></p>  </div>
